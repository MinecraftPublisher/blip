const version="1.2.1";function http(e){var r=new XMLHttpRequest;return r.open("GET",e,!1),r.send(null),r.responseText}function escapeHtml(e){return e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function mulberry32(r){return function(){var e=r+=1831565813,e=Math.imul(e^e>>>15,1|e);return(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}}let modules={};const _blip=(v,j)=>{let l=[],r=-1e5,a=0,I=0,t=[],n=0,w=0,s="";const i=e=>{v("<span cyan>blip kernel</span>\n<span magenta bold>v"+version+"</span>"+(localStorage.getItem("notice-done")??'\n<span yellow>use the "help" command to see available commands, or use the "files" command to edit files.</span>')),localStorage.setItem("notice-done",""),r=parseInt(setInterval(()=>{if(0===a){if(0<I)return I--;if(n%10==0?(localStorage.setItem("blip-fs",JSON.stringify(A)),n=1):n++,a++,0<l.length){let r=l[0];const b=o=>{let c=0;s=o.arr.map(e=>e.cmd+" "+e.args.join(" ")).join("\n");for(let i=0;i<o.arr.length;i++){if(0<c)return c--;w=i;let s=o.arr[i];var e,r,l=s.cmd;if("#"!==l&&"//"!==l&&""!==l)if("echo"===l)v(...s.args);else if("clear"===l)j();else if("wait"===l)I+=parseInt(s.args[0]);else if("write"===l)A[s.args[0]]=s.args.slice(1).join(" ").replaceAll("\\n","\n");else if("read"===l)D[s.args[0]]=A[s.args.slice(1).join(" ")];else if("if"===l||"!if"===l){var a="!if"===l;let e=" "+(s.args.join(" ").match(/(==|!=|\|\||>|<|<=|>=)/g)||[])[0]+" ";var t=(0,eval)(s.args.join(" ").split(e)[0]),n=(0,eval)(s.args.join(" ").split(e)[0]);let r=!1;var p=e=>"true"===e,p=("=="===(e=e.substring(1,e.length-1))?r=t===n:"!="===e?r=t!==n:"||"===e?r=p(t)||p(n):"&&"===e?r=p(t)&&p(n):">"===e||"<"===e?r=parseInt(t)>parseInt(n):">="===e||"<="===e?r=parseInt(t)>=parseInt(n):v('error: unsupported condition "'+e+'"'),(e=>{var r=Math.floor(1e20*y()),l={time:+new Date,id:r,arr:[]};let a=s.cmd+s.args.join(" "),t=0,n=i+c;for(;(!a.startsWith("}")||0!==t)&&o.arr.length>n;)n=i+c,"}"===o.arr[n].cmd&&0<t&&t--,a=o.arr[n].cmd+o.arr[n].args.join(" "),e.includes(o.arr[n].cmd)?t++:l.arr.push(o.arr[n]),c++;return l.arr=l.arr.slice(0,l.arr.length-1),l})(["if","!if"]));(r&&!a||!r&&a)&&b(p)}else if("function"===l){t=s.args[0],n=(e=>{var r=Math.floor(1e20*y()),l={time:+new Date,id:r,arr:[]};let a=s.cmd+s.args.join(" "),t=0,n=i+c;for(;(!a.startsWith("}")||0!==t)&&o.arr.length>n;)n=i+c,"}"===o.arr[n].cmd&&0<t&&t--,a=o.arr[n].cmd+" "+o.arr[n].args.join(" "),e.includes(o.arr[n].cmd)?t++:l.arr.push(o.arr[n]),c++;return l.arr=l.arr.slice(0,l.arr.length-1),l})(["function"]);let e=n.arr.map(e=>e.cmd+" "+e.args.join(" ")).join("\n");a=(e.match(/^(define .+\n{0,1})+/g)||[]).map(e=>e.substring(0,e.length-1).split(" ").slice(1).join(" ")),p=(e=e.replaceAll(/^(define .+\n{0,1})+/g,""),n.arr=e.split("\n").map(e=>({cmd:e.split(" ")[0],args:e.split(" ").slice(1)})),{function:!0,name:t,args:a,data:n});D[t]=p}else if("define"===l)v("<span yellow>warning: define is not supported outside of functions and therefore has no effect.</span>");else if("run"===l)A[s.args.join(" ")]?_.run(A[s.args.join(" ")]):v('error: file not found: "'+s.args.join(" ")+'"');else if("download"===l){var m=s.args[0],g=s.args.slice(1).join(" ");D[m]=escapeHtml(http(g))}else if("import"===l){var u,m=http(s.args.join(" ")),d=JSON.parse(m);for(u in d){let n=d[u];modules[n.name]=(e,r,l,a,t)=>(console.log(n.function),(0,eval)(`(_cmd, _args, _fs, _memory, _shell) => {
                                    let cmd = _cmd ?? null
                                    let args = _args ?? null
                                    let fs = _fs ?? null
                                    let memory = _memory ?? null
                                    let shell = _shell ?? null

                                    let stdout = _shell.stdout

                                    ${n.function}
                                }`)(e,r,l,a,t))}}else if("sadge"===l)v("<span cyan>:(</span>");else if(D[l]&&!0===D[l].function){var f,h={...D[l]},g=h.args.map((e,r)=>({name:e,value:s.args[r]||"undefined"}));let e=h.data.arr.map(e=>e.cmd+" "+e.args.join(" ")).join("DIVIDER\nDIVIDER");for(f of g)console.log(f,h),f.value&&(e=e.replaceAll("["+f.name+"]",f.value.toString()));b({id:y(),time:+new Date,arr:e.split("DIVIDER\nDIVIDER").map(e=>({cmd:e.split(" ")[0],args:e.split(" ").slice(1)}))})}else"="===s.args[0]?(e=l,r=(0,eval)(s.args.slice(1).join(" ")),D[e]=r):modules[s.cmd]?modules[s.cmd](l,s.args,A,D,_):v('error: unknown command "'+l+'" in line "'+s.cmd+" "+s.args.join(" ")+'"')}};b(r),0===(l=l.filter(e=>e.id!==r.id)).length&&v(null)}a--}},249<1e3/e?249:1e3/e).toString())};let y=mulberry32(Math.random()*+new Date),A={},D={};const _={stdin:(...e)=>t.push(e),stdout:v,stdclear:j,line:()=>w+1,code:()=>s,filesystem:e=>(e&&delete A[e],A),memory:()=>D,write:(e,r)=>A[e]=r,build:(e=20)=>{A=JSON.parse(localStorage.getItem("blip-fs"))||{},i(e),A["main.blip"]?_.run("run main.blip"):v(null),_.build=()=>{throw"kernel error: Cannot build a kernel that is already built"},_.stop=()=>{clearInterval(r),localStorage.setItem("blip-fs",JSON.stringify(A)),D={},A={}}},stop:()=>{throw"kernel error: Cannot stop a kernel that is not loaded yet"},run:e=>{var r=Math.floor(1e20*y()),e=e.replaceAll("\r","").replaceAll(/function [^}]+ {\n([^}]+\n)+}/g,e=>e.replaceAll(/[^\\]\[[^\]]+\]/g,e=>e.substring(0,1)+"\\"+e.substring(1))).split("\n").map(e=>{let r=e??"";for(;r.startsWith(" ");)r=r.substring(1);for(;r.match(/[^\\]\[[^\]]+\]/g);)r=r.replaceAll(/[^\\]\[[^\]]+\]/g,e=>e.substring(0,1)+D[e.substring(2,e.length-1)]);var e=(r=r.replaceAll(/\\\[[^\]]+\]/g,e=>e.substring(1))).split(" ")[0],l=mulberry32(+new Date*Math.random()*128378);let a=Math.floor(Math.random()*l()*200).toString();return{cmd:e,args:r.replaceAll("\\ ",a).split(" ").slice(1).map(e=>e.replaceAll(a," "))??[]}});l.push({time:+new Date,id:r,arr:e})}};return _},blip=_blip;export{blip};